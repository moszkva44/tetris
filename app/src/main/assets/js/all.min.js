var globals={matrix:[],game:null,shapemanager:null,ui:{dimensions:{},elements:{}},shapes:["I","T","O","J","L","S","Z"],extraShapes:["H","X","U","D","1","2","/"],levelFrequences:[400,380,360,340,320,300,275,250,225,200,175,150,125,120,115,100],levelMotionRatios:[10,10,10,10,10,10,10,10,10,10,8,8,7,6,5,5],levelThresholds:[0,2,2,3,3,4,4,5,5,6,6,7,7,8,9,9,10],devmode:!0};globals.ui.elements={tetrisInput:!1,tetrisGame:!1,tetrisMenu:!1,menu:!1,newButton:!1,pauseButton:!1,continueButton:!1,gridOnButton:!1,gridOffButton:!1,game_over_screen:!1,paused_screen:!1,imgGameOver:!1,start_screen:!1,clickStartButton:!1,gameModeSelector:!1,levelSelector:!1,fpsCounter:!1},globals.ui.dimensions={blockSize:-1,hiddenTopRows:4,gameWidth:-1,gameHeight:-1,menuWidth:-1,menuHeight:60,nextBlockSize:12,nextBlockMarginLeft:-1,nextBlockMarginTop:7,menuFontSize:-1,inputWidth:-1,inputHeight:100,buttonWidth:-1,tetrisInputRect:-1};class ShapeFinder{#fallingShapes;constructor(fallingShapes){this.#fallingShapes=fallingShapes}checkPositionedBrick(item){var result=!0,item=this.#searchSameGroup(item.x,item.y,[item]);item.forEach(function(groupItem){(23==groupItem.x||1==globals.matrix.get()[groupItem.x+1][groupItem.y]&&globals.matrix.get()[groupItem.x+1][groupItem.y].getFillColor()!=groupItem.brick.getFillColor())&&(result=!1)}),result&&this.#fallingShapes.push(ShapeFactory.createFromPositionedBricks(item,!0))}getShapes(){return this.#fallingShapes}#isIncluded(arr,searchedItem){return arr.some(function(el){return el.x==searchedItem.x&&el.y==searchedItem.y})}#searchSameGroup(x,y,bricks=[]){new PositionedBrick(globals.matrix.get()[x][y],new Position(x,y));if(0<y&&1==globals.matrix.get()[x][y-1]&&globals.matrix.get()[x][y-1].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x][y-1],new Position(x,y-1));this.#isIncluded(bricks,item)||(bricks.push(item),bricks=this.#searchSameGroup(x,y-1,bricks))}if(y<9&&1==globals.matrix.get()[x][y+1]&&globals.matrix.get()[x][y+1].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x][y+1],new Position(x,y+1));this.#isIncluded(bricks,item)||(bricks.push(item),bricks=this.#searchSameGroup(x,y+1,bricks))}if(0<x&&1==globals.matrix.get()[x-1][y]&&globals.matrix.get()[x-1][y].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x-1][y],new Position(x-1,y));this.#isIncluded(bricks,item)||(bricks.push(item),bricks=this.#searchSameGroup(x-1,y,bricks))}if(x<23&&1==globals.matrix.get()[x+1][y]&&globals.matrix.get()[x+1][y].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x+1][y],new Position(x+1,y));this.#isIncluded(bricks,item)||(bricks.push(item),bricks=this.#searchSameGroup(x+1,y,bricks))}return bricks}isPositionedBrickInFallingShapes(positionedBrick){var result=!1;return this.#fallingShapes.forEach(function(shape){shape.hasThisBrick(positionedBrick.brick)&&(result=!0)}),result}}class MoveRegister{static#moves=[];static add(x,y,direction,count=10){MoveRegister.#moves.push({x:x,y:y,direction:direction,count:count})}static reset(){MoveRegister.#moves=[]}static remove(x,y){var i=[];MoveRegister.#moves.forEach(function(move,index){move.x==x&&move.y==y&&i.push(index)}),i.forEach(function(index){MoveRegister.#moves.splice(index,1)})}static get(x,y){var result=!1;return MoveRegister.#moves.forEach(function(move){move.x==x&&move.y==y&&0<move.count&&(result=move)}),result}static finishMove(x,y){var i=-1;MoveRegister.#moves.forEach(function(move,index){move.x==x&&move.y==y&&(MoveRegister.#moves[index].count=MoveRegister.#moves[index].count-1,i=index)}),-1<i&&0==MoveRegister.#moves[i].count&&MoveRegister.#moves.splice(i,1)}}class FloatingScore{constructor(score=0,line=0){this.score=score,this.line=line-2,this.opacity=1,this.y=this.line*ui.dimensions.blockSize-ui.dimensions.blockSize/2,this.dy=-1}draw(ctx){0<this.score&&0<this.line&&(this.y=this.y+this.dy,ctx.font="20px Terminal bold",ctx.fillStyle="rgba(255, 255, 255, "+this.opacity+")",ctx.fillText("+"+this.score,4*ui.dimensions.blockSize,this.y),this.opacity=this.opacity-this.opacity/120)}}class FloatingCaption{constructor(caption="",line=0){this.caption=caption,this.line=line-2,this.opacity=1,this.y=this.line*ui.dimensions.blockSize-ui.dimensions.blockSize/2,this.dy=-1}draw(ctx){""!=this.caption&&0<this.line&&(this.y=this.y+this.dy,ctx.font="20px Terminal bold",ctx.fillStyle="rgba(255, 255, 255, "+this.opacity+")",ctx.fillText(this.caption,2*ui.dimensions.blockSize,this.y),this.opacity=this.opacity-this.opacity/120)}}class Position{constructor(x,y){this.x=x,this.y=y}}class Dimension{constructor(position,width,height){this.position=position,this.width=width,this.height=height}get x(){return this.position.x}get y(){return this.position.y}get x1(){return this.position.x}get y1(){return this.position.y}get x2(){return this.position.x+this.width}get y2(){return this.position.y+this.height}}class CascadeManager{static#fallingShapes=[];static getFloatingShapes(){return CascadeManager.#fallingShapes}static addFallingShapes(shape){CascadeManager.#fallingShapes.push(shape)}static collectFloatingShapes(){if(globals.shapemanager.hasShape()&&globals.shapemanager.getShape().isAdded())return!1;if(0<CascadeManager.#fallingShapes.length&&"BATCH"==CascadeManager.#fallingShapes[0].type)return CascadeManager.gc(),!1;for(var shapefinder=new ShapeFinder(CascadeManager.#fallingShapes),y=0;y<=9;y++)for(var x=22;4<=x;x--){var item=new PositionedBrick(globals.matrix.get()[x][y],new Position(x,y));1!=globals.matrix.get()[x][y]||0!=globals.matrix.get()[x+1][y]||shapefinder.isPositionedBrickInFallingShapes(item)||shapefinder.checkPositionedBrick(item)}CascadeManager.#fallingShapes=shapefinder.getShapes()}static moveFloatingShapesOneStepDown(){var indexesToRemove=[];CascadeManager.#fallingShapes.forEach(function(shape,index){globals.shapemanager.setShape(shape),globals.shapemanager.move(MOVE.DOWN,!0),globals.shapemanager.getShape()&&!shape.isEmpty()||indexesToRemove.push(index)}),indexesToRemove.forEach(function(index){CascadeManager.#fallingShapes.splice(index,1)}),0==CascadeManager.#fallingShapes.length&&globals.shapemanager.callRemoveFullRows(!0)}static gc(){var indexesToRemove=[];CascadeManager.#fallingShapes.forEach(function(shape,index){"BATCH"==shape.type&&shape.isEmpty()&&indexesToRemove.push(index)}),indexesToRemove.forEach(function(index){CascadeManager.#fallingShapes.splice(index,1)})}}class Brick{static#cachedBackground={};value=1;falling=!1;constructor(fillColor="rgb(79 49 97)",borderColor="white"){this.fillColor=fillColor,this.borderColor=borderColor}valueOf(){return this.value}toString(){return this.value}getFillColor(){return this.fillColor}setFillColor(val){this.fillColor=val}setBorderColor(val){this.borderColor=val}getBorderColor(){return this.borderColor}draw(ctx,x,y){var canvas,ctxTmp,img,rgb,d=new Dimension(new Position(y,x-ui.dimensions.hiddenTopRows*ui.dimensions.blockSize),ui.dimensions.blockSize,ui.dimensions.blockSize);Brick.#cachedBackground[this.fillColor]?ctx.drawImage(Brick.#cachedBackground[this.fillColor],d.x1,d.y1):((canvas=new OffscreenCanvas(ui.dimensions.blockSize,ui.dimensions.blockSize)).width=ui.dimensions.blockSize,canvas.height=ui.dimensions.blockSize,ctxTmp=canvas.getContext("2d"),img=new Image,rgb=utils.convertColorNameToRGB(this.fillColor),img.onload=()=>{ctxTmp.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height),ctxTmp.fillStyle=`rgb(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.7)`,ctxTmp.fillRect(0,0,d.width,d.height),ctxTmp.strokeStyle=this.borderColor,ctxTmp.strokeRect(0,0,d.width,d.height),Brick.#cachedBackground[this.fillColor]=canvas,this.draw(ctx,x,y)},img.src="img/brick.png")}drawAsNext(ctx,x,y){y=new Dimension(new Position(y*ui.dimensions.nextBlockSize+ui.dimensions.nextBlockMarginLeft,x*ui.dimensions.nextBlockSize+ui.dimensions.nextBlockMarginTop),ui.dimensions.nextBlockSize,ui.dimensions.nextBlockSize);ctx.fillStyle=this.fillColor,ctx.fillRect(y.x1,y.y1,y.width,y.height),ctx.strokeStyle=this.borderColor,ctx.strokeRect(y.x1,y.y1,y.width,y.height)}}class GhostBrick extends Brick{value=0}class PositionedBrick{constructor(brick,position){this.brick=brick,this.position=position}get x(){return this.position.x}get y(){return this.position.y}}class Button{constructor(name,dimension){this.name=name,this.dimension=dimension,this.cachedImage={touched:!1,untouched:!1}}positionInRange(pos){return pos.x>=this.dimension.x&&pos.x<=this.dimension.x2&&pos.y>=this.dimension.y&&pos.y<=this.dimension.y2}draw(touched=!1){var canvas,ctx,img,key=touched?"touched":"untouched";return this.cachedImage[key]||(canvas=new OffscreenCanvas(this.dimension.width+10,this.dimension.height+10),ctx=canvas.getContext("2d"),(img=new Image).onload=()=>{ctx.drawImage(img,0,0,400,400,0,0,this.dimension.width,this.dimension.height)},img.src=touched?"img/"+this.name+"_touched.png":"img/"+this.name+".png",this.cachedImage[key]=canvas),this.cachedImage[key]}}class Direction{constructor(stepX,stepY){this.stepX=parseInt(stepX),this.stepY=parseInt(stepY)}}class AnimManager{#linesToBlink=[];#gridNeeded=!0;#lastDisplayedNextShape=!1;#buttonClicked=!1;#score;#caption;#lastrun=!1;#frmReqId=!1;#ctx;#ctx2;#ctx3;static buttons={};static#cachedBackground=!1;static#fpsCounter=0;static#fptCounterInterval=!1;init(){this.stop(),this.#ctx=ui.elements.tetrisGame.getContext("2d"),this.#ctx2=ui.elements.tetrisMenu.getContext("2d"),this.#ctx3=ui.elements.tetrisInput.getContext("2d"),this.#ctx3.fillStyle="black",this.#ctx3.fillRect(0,0,ui.elements.tetrisInput.width,ui.elements.tetrisInput.height),AnimManager.buttons.leftButton=new Button("left",new Dimension(new Position(5,5),ui.dimensions.buttonWidth,ui.dimensions.inputHeight-10)),AnimManager.buttons.rightButton=new Button("right",new Dimension(new Position(2*ui.dimensions.buttonWidth+15,5),ui.dimensions.buttonWidth,ui.dimensions.inputHeight-10)),AnimManager.buttons.upButton=new Button("up",new Dimension(new Position(ui.dimensions.buttonWidth+10,5),ui.dimensions.buttonWidth,(ui.dimensions.inputHeight-10)/2)),AnimManager.buttons.downButton=new Button("down",new Dimension(new Position(ui.dimensions.buttonWidth+10,(ui.dimensions.inputHeight-10)/2+10),ui.dimensions.buttonWidth,ui.dimensions.inputHeight-60)),this.#score=new FloatingScore,this.#caption=new FloatingCaption,globals.devmode&&(AnimManager.#fptCounterInterval=setInterval(function(){ui.elements.fpsCounter.innerText=AnimManager.#fpsCounter,AnimManager.#fpsCounter=0},1e3)),this.anim()}anim(){if(this.#frmReqId=requestAnimationFrame(()=>this.anim()),AnimManager.#fpsCounter++,!globals.game.running||!EventManager.registeredCallback||globals.shapemanager.getShape()&&globals.shapemanager.getShape().isFalling()||(EventManager.registeredCallback(),EventManager.registeredCallback=!1),!1!==this.#lastrun&&window.performance.now()-this.#lastrun<globals.game.getSpeedBylevel()/globals.levelMotionRatios[globals.game.getLevel()])return!1;this.#drawBackground(),this.#drawMenu(),this.#drawInput(),globals.game.intervalCore(),globals.matrix.draw(this.#ctx),this.#linesToBlink.forEach(line=>{this.#blinkLine(line)}),this.#score.draw(this.#ctx),this.#caption.draw(this.#ctx),this.#lastrun=window.performance.now()}#drawBackground(){var canvas,ctx,img,that;AnimManager.#cachedBackground?this.#ctx.drawImage(AnimManager.#cachedBackground,0,0):(canvas=new OffscreenCanvas(ui.dimensions.gameWidth,ui.dimensions.gameHeight),ctx=canvas.getContext("2d"),img=new Image,that=this,img.onload=()=>{if(ctx.drawImage(img,0,0,img.width,img.height,0,0,ui.dimensions.gameWidth,ui.dimensions.gameHeight),that.#gridNeeded){for(var x=0;x<=ui.dimensions.gameWidth;x+=ui.dimensions.blockSize)ctx.beginPath(),ctx.strokeStyle="rgb(240 240 240 )",ctx.moveTo(x,0),ctx.lineTo(x,ui.dimensions.gameHeight),ctx.stroke();for(var y=0;y<=ui.dimensions.gameHeight;y+=ui.dimensions.blockSize)ctx.beginPath(),ctx.strokeStyle="rgb(240 240 240 )",ctx.moveTo(0,y),ctx.lineTo(ui.dimensions.gameWidth,y),ctx.stroke()}AnimManager.#cachedBackground=canvas},img.src="img/background.jpg")}#drawMenu(){var ctx=this.#ctx2,nextShapeToDisplay=(ctx.fillStyle="black",ctx.fillRect(0,0,ui.dimensions.menuWidth,ui.dimensions.menuHeight),ctx.font=ui.dimensions.menuFontSize+"px Terminal",ctx.fillStyle="white",ctx.fillText("SCORE: "+parseInt(globals.game.getScore()).toLocaleString(),4,16),ctx.fillText("RECORD: "+parseInt(globals.game.getRecord()).toLocaleString(),4,34),ctx.fillText("LEVEL: "+globals.game.getLevel(),4,52),this.#lastDisplayedNextShape);(nextShapeToDisplay=globals.game.getNextShape()&&globals.shapemanager.getShape()&&4<=globals.shapemanager.getShape().getPosition().x?globals.game.getNextShape():nextShapeToDisplay)?(nextShapeToDisplay.drawAsNextShape(ctx),this.#lastDisplayedNextShape=nextShapeToDisplay):ShapeFactory.create("EMPTY").drawAsNextShape(ctx)}#drawInput(){var that=this;Object.keys(AnimManager.buttons).forEach(key=>{isNaN(key)&&that.#ctx3.drawImage(AnimManager.buttons[key].draw(that.#buttonClicked==key),AnimManager.buttons[key].dimension.x,AnimManager.buttons[key].dimension.y)})}#blinkLine(line){for(var y=0;y<=10;y++)new GhostBrick("white").draw(this.#ctx,line*ui.dimensions.blockSize,y*ui.dimensions.blockSize)}setGridNeeded(val){this.#gridNeeded=val,this.resetCache()}resetCache(){AnimManager.#cachedBackground=!1}blinkLines(lines=[]){this.#linesToBlink=lines,setTimeout(()=>{this.#linesToBlink=[]},100)}displayAddedScore(score,line){this.#score=new FloatingScore(score,line),setTimeout(()=>{this.#score=new FloatingScore},2e3)}displayCaption(caption,line){this.#caption=new FloatingCaption(caption,line),setTimeout(()=>{this.#caption=new FloatingCaption},2e3)}whichButtonTouched(x,y){var result=!1;return Object.keys(AnimManager.buttons).forEach(key=>{isNaN(key)&&AnimManager.buttons[key].positionInRange(new Position(x,y))&&(result=key)}),this.#buttonClicked=result,setTimeout(()=>{this.#buttonClicked=!1},100),result}stop(){this.#frmReqId&&cancelAnimationFrame(this.#frmReqId),AnimManager.#fptCounterInterval&&clearInterval(AnimManager.#fptCounterInterval)}}class ShapeFactory{static#shapes={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[1,1],[1,1]],T:[[0,1,0],[1,1,1],[0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],EMPTY:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],H:[[1,0,1],[1,1,1],[1,0,1]],X:[[0,1,0],[1,1,1],[0,1,0]],U:[[1,0,1],[1,0,1],[1,1,1]],D:[[1,1,1],[1,0,1],[1,1,1]],1:[[1]],2:[[0,0,0],[1,1,0],[0,0,0]],"/":[[0,1],[1,0]]};static#colors={I:"DarkCyan",J:"blue",O:"Gold",L:"OrangeRed",S:"green",Z:"red",T:"magenta",EMPTY:"white"};static create(type){for(var shape=new Shape(type),matrix=ShapeFactory.#shapes[type]||ShapeFactory.#shapes.O,i=0;i<=utils.getRandomInRange(0,3);i++)matrix=utils.rotateMatrix(matrix);var brickMatrix=[];return matrix.forEach(function(row,x){brickMatrix[x]=[],row.forEach(function(col,y){brickMatrix[x][y]=1==col?new Brick(ShapeFactory.#colors[type]):col})}),shape.setMatrix(brickMatrix),shape}static createFromPositionedBricks(positionedBricks,falling=!1){for(var matrix=new Matrix,shape=new Shape("B"),tmpMatrix=[],newMatrix=[],posX=!1,posY=!1,newY=(matrix.init(),positionedBricks.forEach(function(positionedBrick){matrix.get()[positionedBrick.x][positionedBrick.y]=positionedBrick.brick}),matrix.get().forEach(function(row,x){var cols=[];row.forEach(function(col){cols.push(col)}),-1<cols.join("").indexOf("1")&&(!1===posX&&(posX=x),tmpMatrix.push(cols))}),0),y=0;y<=9;y++){var column=utils.extractColumn(tmpMatrix,y),rows=[];column.forEach(function(val){rows.push(val)}),-1<rows.join("").indexOf("1")&&(!1===posY&&(posY=y),rows.forEach(function(val,x){void 0===newMatrix[x]&&(newMatrix[x]=[]),newMatrix[x][newY]=val}),newY++)}return shape.setMatrix(newMatrix),shape.setPosition(posX,posY),shape.falling=falling,shape}}let MOVE={LEFT:new Direction(0,-1),RIGHT:new Direction(0,1),UP:new Direction(-1,0),DOWN:new Direction(1,0)};class ShapeManager{#shape;constructor(){this.#shape=!1}addShape(shape){this.#shape=shape,this.#shape.setAdded(),this.#shape.setPosition(0,3),this.#shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=pos.brick})}hasShape(){return 0!=this.#shape}getShape(){return this.#shape}setShape(shape){this.#shape=shape}removeShape(){this.#shape=!1}callRemoveFullRows=function(falling=!1){return globals.matrix.removeFullRows(function(indexes){var score=globals.game.addScoreByRemovedRowIndexes(indexes);globals.game.getAnimManager().displayAddedScore(score,Math.min(...indexes)),globals.game.getAnimManager().blinkLines(indexes),falling&&(globals.game.scoreMultipler=2*globals.game.scoreMultipler,globals.game.getAnimManager().displayCaption("x"+globals.game.scoreMultipler,17)),globals.game.increaseRemovedRowsNumber(indexes.length)})};move(dir,dontAddScoreForBePlaced=!1,userInput=!1){return!(!this.#shape||!globals.game.running||userInput&&this.#shape.isFalling())&&void(this.#check(dir)?(userInput=this.#shape.getPosition(),this.#shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=0}),this.#shape.setPosition(userInput.x+dir.stepX,userInput.y+dir.stepY),this.#shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=pos.brick,MoveRegister.add(pos.x,pos.y,dir,globals.levelMotionRatios[globals.game.getLevel()])})):dir==MOVE.DOWN&&(this.#shape.placedOnTop()?globals.game.gameOver():(this.#shape.isFalling()||this.callRemoveFullRows(),dontAddScoreForBePlaced||globals.game.addScore(10),this.#shape=!1)))}#check(dir){var result,shape;return!!this.#shape&&(result=!0,shape=this.#shape,this.#shape.getPoints().forEach(function(pos){!(0==pos.y&&dir==MOVE.LEFT||9==pos.y&&dir==MOVE.RIGHT||23==pos.x&&dir==MOVE.DOWN)&&(1!=globals.matrix.get()[pos.x+dir.stepX][pos.y+dir.stepY]||shape.hasThisBrick(globals.matrix.get()[pos.x+dir.stepX][pos.y+dir.stepY]))||(result=!1)}),result)}#checkRotate(){var result=!0,tmpRotatedMatrix=this.#shape.rotate(),tmpShape=new Shape;return tmpShape.setMatrix(tmpRotatedMatrix),tmpShape.setPosition(this.#shape.getPosition().x,this.#shape.getPosition().y),tmpShape.getPoints().forEach(function(pos){!(9<pos.y||pos.y<0||23<pos.x)&&(1!=globals.matrix.get()[pos.x][pos.y]||tmpShape.hasThisBrick(globals.matrix.get()[pos.x][pos.y]))||(result=!1)}),result}rotate(userInput=!1){return!("O"==this.#shape||!1===this.#shape||!globals.game.running||userInput&&this.#shape.isFalling())&&void(this.#checkRotate()&&(this.#shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=0}),this.#shape.setMatrix(this.#shape.rotate()),this.#shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=pos.brick,MoveRegister.add(pos.x,pos.y,MOVE.UP,globals.levelMotionRatios[globals.game.getLevel()])})))}}class EventManager{static registeredCallback=!1;static clientX=!1;static clientY=!1;static operationInterval=!1;static keyMap={ArrowLeft:MOVE.LEFT,ArrowRight:MOVE.RIGHT,ArrowDown:MOVE.DOWN,ArrowUp:MOVE.UP};static buttonMap={leftButton:MOVE.LEFT,rightButton:MOVE.RIGHT,downButton:MOVE.DOWN,upButton:MOVE.UP};static keyDownHandler(event){event.preventDefault(),event.stopPropagation(),EventManager.callMoveOperation(EventManager.keyMap[event.key])}static touchStartHandler(event){event.preventDefault(),event.stopPropagation(),EventManager.clientX=event.clientX||event.touches[0].clientX,EventManager.clientY=event.clientY||event.touches[0].clientY,EventManager.operationInterval=setInterval(function(lastOperation,lastOperationTime){lastOperation!=MOVE.UP&&EventManager.callMoveOperation(lastOperation),1e3<=window.performance.now()-lastOperationTime&&clearInterval(EventManager.operationInterval)},100,EventManager.callMoveOperation(EventManager.buttonMap[globals.game.getAnimManager().whichButtonTouched(EventManager.clientX-ui.dimensions.tetrisInputRect.left,EventManager.clientY-ui.dimensions.tetrisInputRect.top)]),window.performance.now())}static touchEndHandler(event){clearInterval(EventManager.operationInterval)}static callMoveOperation(dir){let fn=function(){};switch(dir){case MOVE.LEFT:case MOVE.RIGHT:case MOVE.DOWN:fn=function(){globals.shapemanager.move(dir,!1,!0)};break;case MOVE.UP:fn=function(){globals.shapemanager.rotate(!0)}}return utils.isMobile()?fn():EventManager.registeredCallback=fn,dir}}class Shape{#matrix=[];#falling=!1;#added=!1;#pos=new Position(0,0);constructor(type){this.type=type}setMatrix(matrix){this.#matrix=matrix}getMatrix(){return this.#matrix}isFalling(){return this.#falling}set falling(val){this.#falling=val}isAdded(){return this.#added}setAdded(){this.#added=!0}getFormattedMatrix(){var onlyZerosIn1stColumn,formattedMatrix=[];return 4==this.#matrix.length?formattedMatrix=this.#matrix:2==this.#matrix.length?formattedMatrix=[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]:(onlyZerosIn1stColumn=-1==utils.extractColumn(this.#matrix,0).indexOf(1),this.#matrix.forEach(function(row){var cols=[];row.forEach(function(col){cols.push(col)}),cols=onlyZerosIn1stColumn?cols.concat([0]):[0].concat(cols),formattedMatrix.push(cols)}),formattedMatrix.push([0,0,0,0])),formattedMatrix}getPoints(){var points=[],pos=this.#pos;return this.#matrix.forEach(function(row,x){row.forEach(function(col,y){1==col&&points.push(new PositionedBrick(col,new Position(pos.x+x,pos.y+y)))})}),points}setPosition(x,y){this.#pos=new Position(x,y)}getPosition(){return this.#pos}hasThisBrick(brick){var ret=!1;return this.#matrix.forEach(function(row,i){row.forEach(function(col,j){col===brick&&(ret=!0)})}),ret}rotate(){return utils.rotateMatrix(this.#matrix)}placedOnTop(){var result=!1,currPos=this.#pos;return this.#matrix.forEach(function(row,x){row.forEach(function(col,y){x+currPos.x==3&&(result=!0)})}),result}drawAsNextShape(ctx){this.getFormattedMatrix().forEach(function(row,x){row.forEach(function(col,y){new Brick(1==col?"gray":"rgb(216 217 232)","white").drawAsNext(ctx,x,y)})})}isEmpty(){return-1==this.#matrix.map(e=>e.join(":")).join(";").indexOf("1")}}var ui={dimensions:{},elements:{},init:function(){ui.dimensions=globals.ui.dimensions,Object.keys(globals.ui.elements).forEach(function(key){isNaN(key)&&(ui.elements[key]=document.getElementById(key))}),ui.dimensions.gameWidth=window.innerWidth-20-(window.innerWidth-20)%10,window.innerHeight-210<ui.dimensions.gameWidth/10*(24-ui.dimensions.hiddenTopRows)&&(ui.dimensions.gameWidth=(window.innerHeight-210-(window.innerHeight-210)%(24-ui.dimensions.hiddenTopRows))/(24-ui.dimensions.hiddenTopRows)*10),ui.dimensions.blockSize=ui.dimensions.gameWidth/10,ui.dimensions.gameHeight=ui.dimensions.blockSize*(24-ui.dimensions.hiddenTopRows),ui.dimensions.menuWidth=ui.dimensions.gameWidth,ui.dimensions.nextBlockMarginLeft=ui.dimensions.gameWidth-53,ui.dimensions.inputWidth=ui.dimensions.menuWidth,ui.dimensions.buttonWidth=ui.dimensions.inputWidth/3-7,ui.elements.tetrisGame.width=ui.dimensions.gameWidth,ui.elements.tetrisGame.height=ui.dimensions.gameHeight,ui.elements.tetrisMenu.width=ui.dimensions.menuWidth,ui.elements.tetrisMenu.height=ui.dimensions.menuHeight,ui.elements.menu.style.width=ui.dimensions.gameWidth+"px",ui.elements.tetrisInput.width=ui.dimensions.inputWidth,ui.elements.tetrisInput.height=ui.dimensions.inputHeight,ui.dimensions.menuFontSize=parseInt(16/217*ui.dimensions.nextBlockMarginLeft),ui.dimensions.menuFontSize=16<ui.dimensions.menuFontSize?16:ui.dimensions.menuFontSize,ui.dimensions.tetrisInputRect=ui.elements.tetrisInput.getBoundingClientRect(),ui.elements.tetrisInput.style.backgroundColor="black",utils.isMobile()?(ui.elements.tetrisInput.addEventListener("touchstart",EventManager.touchStartHandler,{passive:!1}),ui.elements.tetrisInput.addEventListener("touchend",EventManager.touchEndHandler,{passive:!1}),ui.elements.tetrisInput.style.display="block"):(window.addEventListener("keydown",EventManager.keyDownHandler,{passive:!1}),ui.elements.tetrisInput.style.display="none"),ui.elements.newButton.addEventListener("click",ui.renderStartScreen),ui.elements.pauseButton.addEventListener("click",globals.game.pause),ui.elements.continueButton.addEventListener("click",globals.game.continue),ui.setGridNeeded(localStorage.getItem("tetris_grid_needed")&&1==localStorage.getItem("tetris_grid_needed")),ui.elements.gridOnButton.addEventListener("click",function(){ui.setGridNeeded(!0)}),ui.elements.gridOffButton.addEventListener("click",function(){ui.setGridNeeded(!1)}),ui.elements.clickStartButton.addEventListener("click",function(){globals.game.cascade=1==ui.elements.gameModeSelector.value,globals.game.start(ui.elements.levelSelector.value<=15&&0<ui.elements.levelSelector.value?ui.elements.levelSelector.value:0),ui.renderStart()}),ui.renderStartScreen(ui.elements.gameModeSelector.value)},renderGameOver:function(){var pos=ui.coverThisElement(ui.elements.tetrisGame,ui.elements.game_over_screen);ui.elements.imgGameOver.src="img/dog_laugh.gif",ui.elements.imgGameOver.style.width=pos.width-50+"px",ui.elements.pauseButton.style.display="none"},renderPause:function(){ui.elements.pauseButton.style.display="none",ui.elements.continueButton.style.display="",ui.elements.newButton.style.display="none",ui.coverThisElement(ui.elements.tetrisGame,ui.elements.paused_screen),ui.elements.paused_screen.style.lineHeight=ui.elements.paused_screen.style.height},renderContinue:function(){ui.elements.pauseButton.style.display="",ui.elements.continueButton.style.display="none",ui.elements.newButton.style.display="",ui.elements.paused_screen.style.display="none"},renderStartScreen:function(selectedLevel=0){globals.game.running=!1,ui.elements.pauseButton.style.display="none",ui.elements.newButton.style.display="none",ui.elements.continueButton.style.display="none",ui.elements.game_over_screen.style.display="none",ui.coverThisElement(ui.elements.tetrisGame,ui.elements.start_screen),ui.elements.start_screen.style.lineHeight=ui.elements.start_screen.style.height,ui.elements.start_screen.style.verticalAlign="middle",ui.elements.start_screen.style.textAlign="center";var maxLevel=0<(maxLevel=0<selectedLevel?selectedLevel:localStorage.getItem("tetris_reached_level"))&&maxLevel<=15?maxLevel:0;for(let i=ui.elements.levelSelector.options.length-1;0<=i;i--)ui.elements.levelSelector.remove(i);for(let i=0;i<=maxLevel;i++){var option=document.createElement("option");option.value=i,option.text="Level "+i,ui.elements.levelSelector.add(option)}},renderStart:function(){ui.elements.pauseButton.style.display="",ui.elements.newButton.style.display="",ui.elements.continueButton.style.display="none",ui.elements.game_over_screen.style.display="none",ui.elements.start_screen.style.display="none"},setGridNeeded:function(val){val?(ui.elements.gridOnButton.style.display="none",ui.elements.gridOffButton.style.display="",globals.game.getAnimManager().setGridNeeded(!0),localStorage.setItem("tetris_grid_needed",1)):(ui.elements.gridOnButton.style.display="",ui.elements.gridOffButton.style.display="none",globals.game.getAnimManager().setGridNeeded(!1),localStorage.setItem("tetris_grid_needed",0))},coverThisElement:function(coveredObject,coverWidth){coveredObject=coveredObject.getBoundingClientRect();return coverWidth.style.top=coveredObject.top,coverWidth.style.left=coveredObject.left,coverWidth.style.width=coveredObject.width+"px",coverWidth.style.height=coveredObject.height+"px",coverWidth.style.display="block",coveredObject}};class Game{#animManager;#level=0;#score=0;#nextShape=!1;#removedRowsNumber=0;#lastrun=window.performance.now();#working=!1;#record=0;running=!1;constructor(){this.cascade=!1,this.extraShapes=!1,this.scoreMultipler=1,this.#animManager=new AnimManager}intervalCore(){return!!this.running&&!(window.performance.now()-this.#lastrun<this.getSpeedBylevel()||this.#working)&&(this.working=!0,this.cascade&&(CascadeManager.collectFloatingShapes(),0<CascadeManager.getFloatingShapes().length)?(CascadeManager.moveFloatingShapesOneStepDown(),this.#lastrun=window.performance.now(),this.#working=!1):(globals.shapemanager.hasShape()||(MoveRegister.reset(),this.scoreMultipler=1,0==this.#nextShape&&(this.#nextShape=ShapeFactory.create(utils.getRandomShapeID())),globals.shapemanager.addShape(this.#nextShape),this.#nextShape=ShapeFactory.create(utils.getRandomShapeID())),globals.shapemanager.getShape().isFalling()||globals.shapemanager.move(MOVE.DOWN),0<this.#removedRowsNumber&&this.#removedRowsNumber>=globals.levelThresholds[this.getLevel()+1]&&(this.#removedRowsNumber=0,this.levelUp()),this.#working=!1,void(this.#lastrun=window.performance.now())))}getSpeedBylevel(){return globals.levelFrequences[this.#level]}start(level=0){this.init(level),this.running=!0}init(level=0){this.#level=parseInt(level),this.#score=0,this.#nextShape=!1,this.#removedRowsNumber=0,this.running=!1,this.#working=!1,this.#lastrun=window.performance.now(),this.#record=localStorage.getItem("tetris_record")?localStorage.getItem("tetris_record"):0,globals.shapemanager=new ShapeManager,globals.matrix=new Matrix,ui.init(),this.#animManager.init()}getAnimManager(){return this.#animManager}pause(){globals.game.running=!1,ui.renderPause()}continue(){globals.game.running=!0,ui.renderContinue()}getLevel(){return this.#level}levelUp(){this.#level<15&&(this.#level=this.#level+1),localStorage.setItem("tetris_reached_level",this.#level)}addScore(score){this.#score=this.#score+score,this.#score>this.#record&&localStorage.setItem("tetris_record",this.#score)}getScore(){return this.#score}getRecord(){return this.#score>this.#record?this.#score:this.#record}gameOver(){this.running=!1,globals.shapemanager.removeShape(),this.getAnimManager().stop(),parseInt(this.#score)>this.#record&&localStorage.setItem("tetris_record",this.#score),ui.renderGameOver()}getNextShape(){return this.#nextShape}increaseRemovedRowsNumber(val){this.#removedRowsNumber=this.#removedRowsNumber+val}addScoreByRemovedRowIndexes(indexes){indexes=[40,100,300,1200,2400,4800,9600,12e3,16e3,2e4,24e3,28e3,32e3][indexes.length-1]*(this.getLevel()+1);return globals.matrix.isEmpty()&&(indexes+=5e3*(this.getLevel()+1),this.getAnimManager().displayCaption("Cleansheet bonus!",17)),indexes=this.scoreMultipler*indexes,this.addScore(indexes),indexes}}class Matrix{#matrix=[];constructor(){this.init()}get(){return this.#matrix}set(matrix){this.#matrix=matrix}init(){this.#matrix=[];var cols={length:10};Array.from({length:24},()=>Array.from(cols,()=>0)).forEach((row,x)=>{this.#matrix[x]=[],row.forEach((column,y)=>{this.#matrix[x][y]=0})})}getRange(start,end){var cols,result=[];return this.#matrix.forEach(function(row,x){start<=x&&x<=end&&(cols=[],row.forEach(function(element,y){cols.push(1==element?element:0)}),result.push(cols))}),result}removeFullRows(callbackFunc){var tempMatrix=[],removedRowsIndexes=[],lastRemovedLine=4,that=(this.#matrix.forEach((row,x)=>{-1==row.join("").indexOf("0")?(globals.game.cascade?tempMatrix.push(new Array(10).fill(0,0,10)):tempMatrix=[new Array(10).fill(0,0,10)].concat(tempMatrix),removedRowsIndexes.push(x)):tempMatrix.push(row)}),this.#matrix=tempMatrix,this);return globals.game.cascade&&removedRowsIndexes.forEach(function(index){var tmpShape;1<index-lastRemovedLine&&((tmpShape=new Shape("BATCH")).setPosition(lastRemovedLine,0),tmpShape.setMatrix(that.getRange(lastRemovedLine,index-1)),tmpShape.falling=!0,CascadeManager.addFallingShapes(tmpShape)),lastRemovedLine=index}),0<removedRowsIndexes.length&&callbackFunc(removedRowsIndexes),removedRowsIndexes.length}draw(ctx){var motionRatio=globals.levelMotionRatios[globals.game.getLevel()];this.get().forEach(function(row,x){row.forEach(function(col,y){var move;3<x&&1==col&&((move=MoveRegister.get(x,y))?(move.direction==MOVE.DOWN?col.draw(ctx,(x-1)*ui.dimensions.blockSize+ui.dimensions.blockSize/motionRatio*(motionRatio-move.count),y*ui.dimensions.blockSize):move.direction==MOVE.LEFT?col.draw(ctx,x*ui.dimensions.blockSize,(y+1)*ui.dimensions.blockSize-ui.dimensions.blockSize/motionRatio*(motionRatio-move.count)):move.direction==MOVE.RIGHT?col.draw(ctx,x*ui.dimensions.blockSize,(y-1)*ui.dimensions.blockSize+ui.dimensions.blockSize/motionRatio*(motionRatio-move.count)):move.direction==MOVE.UP&&col.draw(ctx,x*ui.dimensions.blockSize,y*ui.dimensions.blockSize),MoveRegister.finishMove(x,y)):col.draw(ctx,x*ui.dimensions.blockSize,y*ui.dimensions.blockSize))})})}isEmpty(){return-1==this.#matrix.map(e=>e.join(":")).join(";").indexOf("1")}}var utils={__bag:[],getRandomShapeID:function(){return 0==utils.__bag.length&&(utils.__bag=(globals.game.extraShapes?globals.extraShapes.concat(globals.shapes):globals.shapes).map(a=>({sort:Math.random(),value:a})).sort((a,b)=>a.sort-b.sort).map(a=>a.value)),utils.__bag.pop()},getRandomInRange:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},extractColumn:function(arr,column){return arr.map(x=>x[column])},extractRow:function(arr,row){return arr[row].map(x=>x)},sleep:function(ms){return new Promise(res=>setTimeout(res,ms))},rotateMatrix:function(matrix){return matrix.map((val,index)=>matrix.map(row=>row[index]).reverse())},convertColorNameToRGB:function(str){var ctx=new OffscreenCanvas(10,10).getContext("2d");return ctx.fillStyle=str,utils.convertHexToRgb(ctx.fillStyle)},convertHexToRgb:function(hex){hex=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return hex?{r:parseInt(hex[1],16),g:parseInt(hex[2],16),b:parseInt(hex[3],16)}:null},isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}};window.onload=function(){globals.game=new Game,globals.game.init()},window.onresize=function(){globals.game=new Game,globals.game.init(),globals.game.getAnimManager().resetCache()};