var globals={matrix:[],game:null,shapemanager:null,ui:{dimensions:{},elements:{}},shapes:["I","T","O","J","L","S","Z"],extraShapes:["H","X","U","D","1","2","/"],levelFrequences:[400,380,360,340,320,300,275,250,225,200,175,150,125,120,115,100],levelThresholds:[0,2,2,3,3,4,4,5,5,6,6,7,7,8,9,9,10],motionRatio:20};function ShapeFinder(fallingShapes){this.__fallingShapes=fallingShapes}globals.ui.elements={tetrisInput:!1,tetrisGame:!1,tetrisMenu:!1,menu:!1,newButton:!1,pauseButton:!1,continueButton:!1,gridOnButton:!1,gridOffButton:!1,game_over_screen:!1,paused_screen:!1,imgGameOver:!1,start_screen:!1,clickStartButton:!1,gameModeSelector:!1,levelSelector:!1},globals.ui.dimensions={blockSize:-1,hiddenTopRows:4,gameWidth:-1,gameHeight:-1,menuWidth:-1,menuHeight:60,nextBlockSize:12,nextBlockMarginLeft:-1,nextBlockMarginTop:7,menuFontSize:-1,inputWidth:-1,inputHeight:100,buttonWidth:-1,tetrisInputRect:-1},ShapeFinder.prototype.checkPositionedBrick=function(item){var result=!0,item=this.__searchSameGroup(item.x,item.y,[item]);item.forEach(function(groupItem){(23==groupItem.x||1==globals.matrix.get()[groupItem.x+1][groupItem.y]&&globals.matrix.get()[groupItem.x+1][groupItem.y].getFillColor()!=groupItem.brick.getFillColor())&&(result=!1)}),result&&this.__fallingShapes.push(ShapeFactory.createFromPositionedBricks(item,!0))},ShapeFinder.prototype.getShapes=function(){return this.__fallingShapes},ShapeFinder.prototype.__isIncluded=function(arr,searchedItem){return arr.some(function(el){return el.x==searchedItem.x&&el.y==searchedItem.y})},ShapeFinder.prototype.__searchSameGroup=function(x,y,bricks=[]){new PositionedBrick(globals.matrix.get()[x][y],new Position(x,y));if(0<y&&1==globals.matrix.get()[x][y-1]&&globals.matrix.get()[x][y-1].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x][y-1],new Position(x,y-1));this.__isIncluded(bricks,item)||(bricks.push(item),bricks=this.__searchSameGroup(x,y-1,bricks))}if(y<9&&1==globals.matrix.get()[x][y+1]&&globals.matrix.get()[x][y+1].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x][y+1],new Position(x,y+1));this.__isIncluded(bricks,item)||(bricks.push(item),bricks=this.__searchSameGroup(x,y+1,bricks))}if(0<x&&1==globals.matrix.get()[x-1][y]&&globals.matrix.get()[x-1][y].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x-1][y],new Position(x-1,y));this.__isIncluded(bricks,item)||(bricks.push(item),bricks=this.__searchSameGroup(x-1,y,bricks))}if(x<23&&1==globals.matrix.get()[x+1][y]&&globals.matrix.get()[x+1][y].getFillColor()==globals.matrix.get()[x][y].getFillColor()){let item=new PositionedBrick(globals.matrix.get()[x+1][y],new Position(x+1,y));this.__isIncluded(bricks,item)||(bricks.push(item),bricks=this.__searchSameGroup(x+1,y,bricks))}return bricks},ShapeFinder.prototype.isPositionedBrickInFallingShapes=function(positionedBrick){var result=!1;return this.__fallingShapes.forEach(function(shape){shape.hasThisBrick(positionedBrick.brick)&&(result=!0)}),result};var MoveRegister={__moves:[],add:function(x,y,direction,count=10){MoveRegister.__moves.push({x:x,y:y,direction:direction,count:count})},reset:function(){MoveRegister.__moves=[]},remove:function(x,y){var i=[];MoveRegister.__moves.forEach(function(move,index){move.x==x&&move.y==y&&i.push(index)}),i.forEach(function(index){MoveRegister.__moves.splice(index,1)})},get:function(x,y){var result=!1;return MoveRegister.__moves.forEach(function(move){move.x==x&&move.y==y&&0<move.count&&(result=move)}),result},finishMove:function(x,y){var i=-1;MoveRegister.__moves.forEach(function(move,index){move.x==x&&move.y==y&&(MoveRegister.__moves[index].count=MoveRegister.__moves[index].count-1,i=index)}),-1<i&&0==MoveRegister.__moves[i].count&&MoveRegister.__moves.splice(i,1)}};function FloatingScore(score=0,line=0){this.score=score,this.line=line,this.opacity=1,this.y=line*ui.dimensions.blockSize-ui.dimensions.blockSize/2,this.dy=-1}function FloatingCaption(caption="",line=0){this.caption=caption,this.line=line,this.opacity=1,this.y=line*ui.dimensions.blockSize-ui.dimensions.blockSize/2,this.dy=-1}function Position(x,y){this.x=x,this.y=y}function Dimension(position,width,height){this.position=position,this.width=width,this.height=height}FloatingScore.prototype.draw=function(ctx){0<this.score&&0<this.line&&(this.y=this.y+this.dy,ctx.font="20px Terminal bold",ctx.fillStyle="rgba(255, 255, 255, "+this.opacity+")",ctx.fillText("+"+this.score,4*ui.dimensions.blockSize,this.y),this.opacity=this.opacity-this.opacity/120)},FloatingCaption.prototype.draw=function(ctx){""!=this.caption&&0<this.line&&(this.y=this.y+this.dy,ctx.font="20px Terminal bold",ctx.fillStyle="rgba(255, 255, 255, "+this.opacity+")",ctx.fillText(this.caption,4*ui.dimensions.blockSize,this.y),this.opacity=this.opacity-this.opacity/120)},Object.defineProperty(Dimension.prototype,"x",{get:function(){return this.position.x}}),Object.defineProperty(Dimension.prototype,"y",{get:function(){return this.position.y}}),Object.defineProperty(Dimension.prototype,"x1",{get:function(){return this.position.x}}),Object.defineProperty(Dimension.prototype,"y1",{get:function(){return this.position.y}}),Object.defineProperty(Dimension.prototype,"x2",{get:function(){return this.position.x+this.width}}),Object.defineProperty(Dimension.prototype,"y2",{get:function(){return this.position.y+this.height}});var CascadeManager={__fallingShapes:[],getFloatingShapes:function(){return CascadeManager.__fallingShapes},collectFloatingShapes:function(){if(globals.shapemanager.hasShape()&&globals.shapemanager.getShape().isAdded())return!1;if(0<CascadeManager.__fallingShapes.length&&"BATCH"==CascadeManager.__fallingShapes[0].type)return!1;for(var shapefinder=new ShapeFinder(CascadeManager.__fallingShapes),y=0;y<=9;y++)for(var x=22;4<=x;x--){var item=new PositionedBrick(globals.matrix.get()[x][y],new Position(x,y));1!=globals.matrix.get()[x][y]||0!=globals.matrix.get()[x+1][y]||shapefinder.isPositionedBrickInFallingShapes(item)||shapefinder.checkPositionedBrick(item)}CascadeManager.__fallingShapes=shapefinder.getShapes()},moveFloatingShapesOneStepDown(){var indexesToRemove=[];CascadeManager.__fallingShapes.forEach(function(shape,index){globals.shapemanager.setShape(shape),globals.shapemanager.move(MOVE.DOWN,!0),globals.shapemanager.getShape()&&0!=shape.getMatrix().length||indexesToRemove.push(index)}),indexesToRemove.forEach(function(index){CascadeManager.__fallingShapes.splice(index,1)}),0==CascadeManager.__fallingShapes.length&&(globals.game.scoreMultipler=2*globals.game.scoreMultipler,0<globals.shapemanager.callRemoveFullRows())&&globals.game.getAnimManager().displayCaption("x"+globals.game.scoreMultipler,17)}};function Brick(fillColor="rgb(79 49 97)",borderColor="white"){this.value=1,this.fillColor=fillColor,this.borderColor=borderColor,this.falling=!1}function PositionedBrick(brick,position){this.brick=brick,this.position=position}function Button(name,dimension){this.name=name,this.dimension=dimension,this.cachedImage={touched:!1,untouched:!1}}function Direction(stepX,stepY){this.stepX=parseInt(stepX),this.stepY=parseInt(stepY)}Brick.__cachedBackground={},Brick.prototype.valueOf=function(){return this.value},Brick.prototype.toString=function(){return this.value},Brick.prototype.getFillColor=function(){return this.fillColor},Brick.prototype.setFillColor=function(val){this.fillColor=val},Brick.prototype.setBorderColor=function(val){this.borderColor=val},Brick.prototype.getBorderColor=function(){return this.borderColor},Brick.prototype.draw=function(ctx,x,y){var canvas,ctxTmp,img,rgb,d=new Dimension(new Position(y,x-ui.dimensions.hiddenTopRows*ui.dimensions.blockSize),ui.dimensions.blockSize,ui.dimensions.blockSize);Brick.__cachedBackground[this.fillColor]?ctx.drawImage(Brick.__cachedBackground[this.fillColor],d.x1,d.y1):((canvas=new OffscreenCanvas(ui.dimensions.blockSize,ui.dimensions.blockSize)).width=ui.dimensions.blockSize,canvas.height=ui.dimensions.blockSize,ctxTmp=canvas.getContext("2d"),img=new Image,rgb=utils.convertColorNameToRGB(this.fillColor),img.onload=()=>{ctxTmp.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height),ctxTmp.fillStyle=`rgb(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.7)`,ctxTmp.fillRect(0,0,d.width,d.height),ctxTmp.strokeStyle=this.borderColor,ctxTmp.strokeRect(0,0,d.width,d.height),Brick.__cachedBackground[this.fillColor]=canvas,this.draw(ctx,x,y)},img.src="img/brick.png")},Brick.prototype.drawAsNext=function(ctx,x,y){y=new Dimension(new Position(y*ui.dimensions.nextBlockSize+ui.dimensions.nextBlockMarginLeft,x*ui.dimensions.nextBlockSize+ui.dimensions.nextBlockMarginTop),ui.dimensions.nextBlockSize,ui.dimensions.nextBlockSize);ctx.fillStyle=this.fillColor,ctx.fillRect(y.x1,y.y1,y.width,y.height),ctx.strokeStyle=this.borderColor,ctx.strokeRect(y.x1,y.y1,y.width,y.height)},Object.defineProperty(PositionedBrick.prototype,"x",{get:function(){return this.position.x}}),Object.defineProperty(PositionedBrick.prototype,"y",{get:function(){return this.position.y}}),Object.defineProperty(PositionedBrick.prototype,"cx",{get:function(){return this.cposition.x}}),Object.defineProperty(PositionedBrick.prototype,"cy",{get:function(){return this.cposition.y}}),Button.prototype.positionInRange=function(pos){return pos.x>=this.dimension.x&&pos.x<=this.dimension.x2&&pos.y>=this.dimension.y&&pos.y<=this.dimension.y2};var AnimManager={__linesToBlink:[],__cachedBackground:!(Button.prototype.draw=function(touched=!1){var canvas,ctx,img,key=touched?"touched":"untouched";return this.cachedImage[key]||(canvas=new OffscreenCanvas(this.dimension.width+10,this.dimension.height+10),ctx=canvas.getContext("2d"),(img=new Image).onload=()=>{ctx.drawImage(img,0,0,400,400,0,0,this.dimension.width,this.dimension.height)},img.src=touched?"img/"+this.name+"_touched.png":"img/"+this.name+".png",this.cachedImage[key]=canvas),this.cachedImage[key]}),__gridNeeded:!0,__buttons:{},__lastDisplayedNextShape:!1,__buttonClicked:!1,__score:!1,__caption:!1,__lastrun:!1,ctx:!1,ctx2:!1,ctx3:!1,frmReqId:!1,init:function(){AnimManager.stop(),AnimManager.ctx=ui.elements.tetrisGame.getContext("2d"),AnimManager.ctx2=ui.elements.tetrisMenu.getContext("2d"),AnimManager.ctx3=ui.elements.tetrisInput.getContext("2d"),ui.elements.tetrisInput.width=ui.elements.tetrisInput.width,ui.elements.tetrisInput.height=ui.elements.tetrisInput.height,AnimManager.ctx3.fillStyle="black",AnimManager.ctx3.fillRect(0,0,ui.elements.tetrisInput.width,ui.elements.tetrisInput.height),AnimManager.__buttons.leftButton=new Button("left",new Dimension(new Position(5,5),ui.dimensions.buttonWidth,ui.dimensions.inputHeight-10)),AnimManager.__buttons.rightButton=new Button("right",new Dimension(new Position(2*ui.dimensions.buttonWidth+15,5),ui.dimensions.buttonWidth,ui.dimensions.inputHeight-10)),AnimManager.__buttons.upButton=new Button("up",new Dimension(new Position(ui.dimensions.buttonWidth+10,5),ui.dimensions.buttonWidth,(ui.dimensions.inputHeight-10)/2)),AnimManager.__buttons.downButton=new Button("down",new Dimension(new Position(ui.dimensions.buttonWidth+10,(ui.dimensions.inputHeight-10)/2+10),ui.dimensions.buttonWidth,ui.dimensions.inputHeight-60)),AnimManager.__score=new FloatingScore,AnimManager.__caption=new FloatingCaption,AnimManager.anim()},anim:function(){if(!globals.game.running||!EventManager.__registeredCallback||globals.shapemanager.getShape()&&globals.shapemanager.getShape().isFalling()||(EventManager.__registeredCallback(),EventManager.__registeredCallback=!1),AnimManager.frmReqId=requestAnimationFrame(AnimManager.anim),!1!==AnimManager.__lastrun&&window.performance.now()-AnimManager.__lastrun<globals.game.getSpeedBylevel()/globals.motionRatio)return!1;AnimManager.__drawBackground(),AnimManager.__drawMenu(),AnimManager.__drawInput(),globals.game.intervalCore(),globals.matrix.draw(AnimManager.ctx),AnimManager.__linesToBlink.forEach(line=>{AnimManager.__blinkLine(line)}),AnimManager.__score.draw(AnimManager.ctx),AnimManager.__caption.draw(AnimManager.ctx),AnimManager.__lastrun=window.performance.now()},__drawBackground:function(){var canvas,ctx,img;AnimManager.__cachedBackground?AnimManager.ctx.drawImage(AnimManager.__cachedBackground,0,0):(canvas=new OffscreenCanvas(ui.dimensions.gameWidth,ui.dimensions.gameHeight),ctx=canvas.getContext("2d"),(img=new Image).onload=function(){if(ctx.drawImage(img,0,0,img.width,img.height,0,0,ui.dimensions.gameWidth,ui.dimensions.gameHeight),AnimManager.__gridNeeded){for(var x=0;x<=ui.dimensions.gameWidth;x+=ui.dimensions.blockSize)ctx.beginPath(),ctx.strokeStyle="rgb(240 240 240 )",ctx.moveTo(x,0),ctx.lineTo(x,ui.dimensions.gameHeight),ctx.stroke();for(var y=0;y<=ui.dimensions.gameHeight;y+=ui.dimensions.blockSize)ctx.beginPath(),ctx.strokeStyle="rgb(240 240 240 )",ctx.moveTo(0,y),ctx.lineTo(ui.dimensions.gameWidth,y),ctx.stroke()}AnimManager.__cachedBackground=canvas},img.src="img/background.jpg")},__drawMenu:function(){AnimManager.ctx2.fillStyle="black",AnimManager.ctx2.fillRect(0,0,ui.dimensions.menuWidth,ui.dimensions.menuHeight),AnimManager.ctx2.font=ui.dimensions.menuFontSize+"px Terminal",AnimManager.ctx2.fillStyle="white",AnimManager.ctx2.fillText("SCORE: "+parseInt(globals.game.getScore()).toLocaleString(),4,16),AnimManager.ctx2.fillText("RECORD: "+parseInt(globals.game.getRecord()).toLocaleString(),4,34),AnimManager.ctx2.fillText("LEVEL: "+globals.game.getLevel(),4,52);var nextShapeToDisplay=AnimManager.__lastDisplayedNextShape;(nextShapeToDisplay=globals.game.getNextShape()&&globals.shapemanager.getShape()&&4<=globals.shapemanager.getShape().getPosition().x?globals.game.getNextShape():nextShapeToDisplay)?(nextShapeToDisplay.drawAsNextShape(AnimManager.ctx2),AnimManager.__lastDisplayedNextShape=nextShapeToDisplay):ShapeFactory.create("EMPTY").drawAsNextShape(AnimManager.ctx2)},__drawInput:function(){Object.keys(AnimManager.__buttons).forEach(function(key){isNaN(key)&&AnimManager.ctx3.drawImage(AnimManager.__buttons[key].draw(AnimManager.__buttonClicked==key),AnimManager.__buttons[key].dimension.x,AnimManager.__buttons[key].dimension.y)})},__blinkLine:function(line){for(var y=0;y<=10;y++){var ghostBrick=new Brick("white");ghostBrick.value=0,ghostBrick.draw(AnimManager.ctx,line*ui.dimensions.blockSize,y*ui.dimensions.blockSize)}},setGridNeeded:function(val){AnimManager.__gridNeeded=val,AnimManager.resetCache()},resetCache:function(){AnimManager.__cachedBackground=!1},blinkLines:function(lines=[]){AnimManager.__linesToBlink=lines,setTimeout(()=>{AnimManager.__linesToBlink=[]},100)},displayAddedScore:function(score,line){AnimManager.__score=new FloatingScore(score,line),setTimeout(()=>{AnimManager.__score=new FloatingScore},2e3)},displayCaption:function(caption,line){AnimManager.__caption=new FloatingCaption(caption,line),setTimeout(()=>{AnimManager.__caption=new FloatingCaption},2e3)},whichButtonTouched:function(x,y){var result=!1;return Object.keys(AnimManager.__buttons).forEach(function(key){isNaN(key)&&AnimManager.__buttons[key].positionInRange(new Position(x,y))&&(result=key)}),AnimManager.__buttonClicked=result,setTimeout(function(){AnimManager.__buttonClicked=!1},100),result},stop:function(){this.frmReqId&&cancelAnimationFrame(AnimManager.frmReqId)}},ShapeFactory={__shapes:{I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],O:[[1,1],[1,1]],T:[[0,1,0],[1,1,1],[0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],S:[[0,1,1],[1,1,0],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]],EMPTY:[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],H:[[1,0,1],[1,1,1],[1,0,1]],X:[[0,1,0],[1,1,1],[0,1,0]],U:[[1,0,1],[1,0,1],[1,1,1]],D:[[1,1,1],[1,0,1],[1,1,1]],1:[[1]],2:[[0,0,0],[1,1,0],[0,0,0]],"/":[[0,1],[1,0]]},__colors:{I:"DarkCyan",J:"blue",O:"Gold",L:"OrangeRed",S:"green",Z:"red",T:"magenta",EMPTY:"white"},create:function(type){for(var shape=new Shape(type),matrix=ShapeFactory.__shapes[type]||ShapeFactory.__shapes.O,i=0;i<=utils.getRandomInRange(0,3);i++)matrix=utils.rotateMatrix(matrix);var brickMatrix=[];return matrix.forEach(function(row,x){brickMatrix[x]=[],row.forEach(function(col,y){brickMatrix[x][y]=1==col?new Brick(ShapeFactory.__colors[type]):col})}),shape.setMatrix(brickMatrix),shape},createFromPositionedBricks:function(positionedBricks,falling=!1){for(var matrix=new Matrix,shape=new Shape("B"),tmpMatrix=[],newMatrix=[],posX=!1,posY=!1,newY=(matrix.init(),positionedBricks.forEach(function(positionedBrick){matrix.get()[positionedBrick.x][positionedBrick.y]=positionedBrick.brick}),matrix.get().forEach(function(row,x){var cols=[];row.forEach(function(col){cols.push(col)}),-1<cols.join("").indexOf("1")&&(!1===posX&&(posX=x),tmpMatrix.push(cols))}),0),y=0;y<=9;y++){var column=utils.extractColumn(tmpMatrix,y),rows=[];column.forEach(function(val){rows.push(val)}),-1<rows.join("").indexOf("1")&&(!1===posY&&(posY=y),rows.forEach(function(val,x){void 0===newMatrix[x]&&(newMatrix[x]=[]),newMatrix[x][newY]=val}),newY++)}return shape.setMatrix(newMatrix),shape.setPosition(posX,posY),shape.__falling=falling,shape}};let MOVE={LEFT:new Direction(0,-1),RIGHT:new Direction(0,1),UP:new Direction(-1,0),DOWN:new Direction(1,0)};function ShapeManager(){this.__shape=!1}ShapeManager.prototype.addShape=function(shape){this.__shape=shape,this.__shape.setAdded(),this.__shape.setPosition(0,3),this.__shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=pos.brick})},ShapeManager.prototype.hasShape=function(){return!1!==this.__shape},ShapeManager.prototype.getShape=function(){return this.__shape},ShapeManager.prototype.setShape=function(shape){this.__shape=shape},ShapeManager.prototype.removeShape=function(){this.__shape=!1},ShapeManager.prototype.callRemoveFullRows=function(){return globals.matrix.removeFullRows(function(indexes){var score=globals.game.addScoreByRemovedRowIndexes(indexes);globals.game.getAnimManager().displayAddedScore(score,Math.min(...indexes)),globals.game.getAnimManager().blinkLines(indexes),globals.game.increaseRemovedRowsNumber(indexes.length)})},ShapeManager.prototype.move=function(dir,dontAddScoreForBePlaced=!1){if(!this.__shape||!globals.game.running)return!1;var currPost;this.__check(dir)?(currPost=this.__shape.getPosition(),this.__shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=0}),this.__shape.setPosition(currPost.x+dir.stepX,currPost.y+dir.stepY),this.__shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=pos.brick,MoveRegister.add(pos.x,pos.y,dir,globals.motionRatio)})):dir==MOVE.DOWN&&(this.__shape.placedOnTop()?globals.game.gameOver():(this.__shape.__falling||this.callRemoveFullRows(),dontAddScoreForBePlaced||globals.game.addScore(10),this.__shape=!1))},ShapeManager.prototype.__check=function(dir){var result,shape;return!!this.__shape&&(result=!0,shape=this.__shape,this.__shape.getPoints().forEach(function(pos){!(0==pos.y&&dir==MOVE.LEFT||9==pos.y&&dir==MOVE.RIGHT||23==pos.x&&dir==MOVE.DOWN)&&(1!=globals.matrix.get()[pos.x+dir.stepX][pos.y+dir.stepY]||shape.hasThisBrick(globals.matrix.get()[pos.x+dir.stepX][pos.y+dir.stepY]))||(result=!1)}),result)},ShapeManager.prototype.__checkRotate=function(){var result=!0,tmpRotatedMatrix=this.__shape.rotate(),tmpShape=new Shape;return tmpShape.setMatrix(tmpRotatedMatrix),tmpShape.setPosition(this.__shape.getPosition().x,this.__shape.getPosition().y),tmpShape.getPoints().forEach(function(pos){!(9<pos.y||pos.y<0||23<pos.x)&&(1!=globals.matrix.get()[pos.x][pos.y]||tmpShape.hasThisBrick(globals.matrix.get()[pos.x][pos.y]))||(result=!1)}),result};var EventManager={__registeredCallback:!(ShapeManager.prototype.rotate=function(){"O"!=this.__shape&&!1!==this.__shape&&globals.game.running&&this.__checkRotate()&&(this.__shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=0}),this.__shape.setMatrix(this.__shape.rotate()),this.__shape.getPoints().forEach(function(pos){globals.matrix.get()[pos.x][pos.y]=pos.brick,MoveRegister.add(pos.x,pos.y,MOVE.UP,globals.motionRatio)}))}),keyMap:{ArrowLeft:MOVE.LEFT,ArrowRight:MOVE.RIGHT,ArrowDown:MOVE.DOWN,ArrowUp:MOVE.UP},buttonMap:{leftButton:MOVE.LEFT,rightButton:MOVE.RIGHT,downButton:MOVE.DOWN,upButton:MOVE.UP},keyDownHandler:function(event){event.preventDefault(),event.stopPropagation(),EventManager.__callMoveOperation(EventManager.keyMap[event.key])},touchHandler:function(event){event.preventDefault(),event.stopPropagation();var clientX=event.clientX||event.touches[0].clientX,event=event.clientY||event.touches[0].clientY;EventManager.__callMoveOperation(EventManager.buttonMap[AnimManager.whichButtonTouched(clientX-ui.dimensions.tetrisInputRect.left,event-ui.dimensions.tetrisInputRect.top)])},__callMoveOperation:function(dir){let fn=function(){};switch(dir){case MOVE.LEFT:case MOVE.RIGHT:case MOVE.DOWN:fn=function(){globals.shapemanager.move(dir)};break;case MOVE.UP:fn=function(){globals.shapemanager.rotate()}}utils.isMobile()?fn():EventManager.__registeredCallback=fn}},Shape=function(type){this.type=type,this.__matrix=[],this.__falling=!1,this.__added=!1,this.__pos=new Position(0,0)},ui=(Shape.prototype.setMatrix=function(matrix){this.__matrix=matrix},Shape.prototype.getMatrix=function(){return this.__matrix},Shape.prototype.isFalling=function(){return this.__falling},Shape.prototype.isAdded=function(){return this.__added},Shape.prototype.setAdded=function(){this.__added=!0},Shape.prototype.getFormattedMatrix=function(){var onlyZerosIn1stColumn,formattedMatrix=[];return 4==this.__matrix.length?formattedMatrix=this.__matrix:2==this.__matrix.length?formattedMatrix=[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]]:(onlyZerosIn1stColumn=-1==utils.extractColumn(this.__matrix,0).indexOf(1),this.__matrix.forEach(function(row){var cols=[];row.forEach(function(col){cols.push(col)}),cols=onlyZerosIn1stColumn?cols.concat([0]):[0].concat(cols),formattedMatrix.push(cols)}),formattedMatrix.push([0,0,0,0])),formattedMatrix},Shape.prototype.getPoints=function(){var points=[],pos=this.__pos;return this.__matrix.forEach(function(row,x){row.forEach(function(col,y){1==col&&points.push(new PositionedBrick(col,new Position(pos.x+x,pos.y+y)))})}),points},Shape.prototype.setPosition=function(x,y){this.__pos=new Position(x,y)},Shape.prototype.getPosition=function(){return this.__pos},Shape.prototype.hasThisBrick=function(brick){var ret=!1;return this.__matrix.forEach(function(row,i){row.forEach(function(col,j){col===brick&&(ret=!0)})}),ret},Shape.prototype.rotate=function(){return utils.rotateMatrix(this.__matrix)},Shape.prototype.placedOnTop=function(){var result=!1,currPos=this.__pos;return this.__matrix.forEach(function(row,x){row.forEach(function(col,y){x+currPos.x==3&&(result=!0)})}),result},Shape.prototype.drawAsNextShape=function(ctx){this.getFormattedMatrix().forEach(function(row,x){row.forEach(function(col,y){new Brick(1==col?"gray":"rgb(216 217 232)","white").drawAsNext(ctx,x,y)})})},{dimensions:{},elements:{},init:function(){ui.dimensions=globals.ui.dimensions,Object.keys(globals.ui.elements).forEach(function(key){isNaN(key)&&(ui.elements[key]=document.getElementById(key))}),ui.dimensions.gameWidth=window.innerWidth-20-(window.innerWidth-20)%10,window.innerHeight-210<ui.dimensions.gameWidth/10*(24-ui.dimensions.hiddenTopRows)&&(ui.dimensions.gameWidth=(window.innerHeight-210-(window.innerHeight-210)%(24-ui.dimensions.hiddenTopRows))/(24-ui.dimensions.hiddenTopRows)*10),ui.dimensions.blockSize=ui.dimensions.gameWidth/10,ui.dimensions.gameHeight=ui.dimensions.blockSize*(24-ui.dimensions.hiddenTopRows),ui.dimensions.menuWidth=ui.dimensions.gameWidth,ui.dimensions.nextBlockMarginLeft=ui.dimensions.gameWidth-53,ui.dimensions.inputWidth=ui.dimensions.menuWidth,ui.dimensions.buttonWidth=ui.dimensions.inputWidth/3-7,ui.elements.tetrisGame.width=ui.dimensions.gameWidth,ui.elements.tetrisGame.height=ui.dimensions.gameHeight,ui.elements.tetrisMenu.width=ui.dimensions.menuWidth,ui.elements.tetrisMenu.height=ui.dimensions.menuHeight,ui.elements.menu.style.width=ui.dimensions.gameWidth+"px",ui.elements.tetrisInput.width=ui.dimensions.inputWidth,ui.elements.tetrisInput.height=ui.dimensions.inputHeight,ui.dimensions.menuFontSize=parseInt(16/217*ui.dimensions.nextBlockMarginLeft),ui.dimensions.menuFontSize=16<ui.dimensions.menuFontSize?16:ui.dimensions.menuFontSize,ui.dimensions.tetrisInputRect=ui.elements.tetrisInput.getBoundingClientRect(),ui.elements.tetrisInput.style.backgroundColor="black",utils.isMobile()?(ui.elements.tetrisInput.addEventListener("touchstart",EventManager.touchHandler,{passive:!1}),ui.elements.tetrisInput.style.display="block"):(window.addEventListener("keydown",EventManager.keyDownHandler,{passive:!1}),ui.elements.tetrisInput.style.display="none"),ui.elements.newButton.addEventListener("click",ui.renderStartScreen),ui.elements.pauseButton.addEventListener("click",globals.game.pause),ui.elements.continueButton.addEventListener("click",globals.game.continue),ui.setGridNeeded(localStorage.getItem("tetris_grid_needed")&&1==localStorage.getItem("tetris_grid_needed")),ui.elements.gridOnButton.addEventListener("click",function(){ui.setGridNeeded(!0)}),ui.elements.gridOffButton.addEventListener("click",function(){ui.setGridNeeded(!1)}),ui.elements.clickStartButton.addEventListener("click",function(){globals.game.cascade=1==ui.elements.gameModeSelector.value,globals.game.start(ui.elements.levelSelector.value<=15&&0<ui.elements.levelSelector.value?ui.elements.levelSelector.value:0),ui.renderStart()}),ui.renderStartScreen(ui.elements.gameModeSelector.value)},renderGameOver:function(){var pos=ui.coverThisElement(ui.elements.tetrisGame,ui.elements.game_over_screen);ui.elements.imgGameOver.src="img/dog_laugh.gif",ui.elements.imgGameOver.style.width=pos.width-50+"px",ui.elements.pauseButton.style.display="none"},renderPause:function(){ui.elements.pauseButton.style.display="none",ui.elements.continueButton.style.display="",ui.elements.newButton.style.display="none",ui.coverThisElement(ui.elements.tetrisGame,ui.elements.paused_screen),ui.elements.paused_screen.style.lineHeight=ui.elements.paused_screen.style.height},renderContinue:function(){ui.elements.pauseButton.style.display="",ui.elements.continueButton.style.display="none",ui.elements.newButton.style.display="",ui.elements.paused_screen.style.display="none"},renderStartScreen:function(selectedLevel=0){globals.game.running=!1,ui.elements.pauseButton.style.display="none",ui.elements.newButton.style.display="none",ui.elements.continueButton.style.display="none",ui.elements.game_over_screen.style.display="none",ui.coverThisElement(ui.elements.tetrisGame,ui.elements.start_screen),ui.elements.start_screen.style.lineHeight=ui.elements.start_screen.style.height,ui.elements.start_screen.style.verticalAlign="middle",ui.elements.start_screen.style.textAlign="center";var maxLevel=0<(maxLevel=0<selectedLevel?selectedLevel:localStorage.getItem("tetris_reached_level"))&&maxLevel<=15?maxLevel:0;for(let i=ui.elements.levelSelector.options.length-1;0<=i;i--)ui.elements.levelSelector.remove(i);for(let i=0;i<=maxLevel;i++){var option=document.createElement("option");option.value=i,option.text="Level "+i,ui.elements.levelSelector.add(option)}},renderStart:function(){ui.elements.pauseButton.style.display="",ui.elements.newButton.style.display="",ui.elements.continueButton.style.display="none",ui.elements.game_over_screen.style.display="none",ui.elements.start_screen.style.display="none"},setGridNeeded:function(val){val?(ui.elements.gridOnButton.style.display="none",ui.elements.gridOffButton.style.display="",globals.game.getAnimManager().setGridNeeded(!0),localStorage.setItem("tetris_grid_needed",1)):(ui.elements.gridOnButton.style.display="",ui.elements.gridOffButton.style.display="none",globals.game.getAnimManager().setGridNeeded(!1),localStorage.setItem("tetris_grid_needed",0))},coverThisElement:function(coveredObject,coverWidth){coveredObject=coveredObject.getBoundingClientRect();return coverWidth.style.top=coveredObject.top,coverWidth.style.left=coveredObject.left,coverWidth.style.width=coveredObject.width+"px",coverWidth.style.height=coveredObject.height+"px",coverWidth.style.display="block",coveredObject}});function Game(){this.cascade=!1,this.extraShapes=!1,this.level=0,this.score=0,this.nextShape=!1,this.removedRowsNumber=0,this.animManager=AnimManager,this.running=!1,this.lastrun=window.performance.now(),this.lastrunCascade=window.performance.now(),this.scoreMultipler=1,this.working=!1}function Matrix(){this.__matrix=[],this.init()}Game.prototype.intervalCore=function(){return!!globals.game.running&&!(window.performance.now()-this.lastrun<this.getSpeedBylevel()||this.working)&&(this.working=!0,this.cascade&&(CascadeManager.collectFloatingShapes(),0<CascadeManager.getFloatingShapes().length)?(CascadeManager.moveFloatingShapesOneStepDown(),this.lastrun=window.performance.now(),this.working=!1):(globals.shapemanager.hasShape()||(this.scoreMultipler=1,0==globals.game.nextShape&&(globals.game.nextShape=ShapeFactory.create(utils.getRandomShapeID())),globals.shapemanager.addShape(globals.game.nextShape),globals.game.nextShape=ShapeFactory.create(utils.getRandomShapeID())),globals.shapemanager.getShape().isFalling()||globals.shapemanager.move(MOVE.DOWN),0<globals.game.removedRowsNumber&&globals.game.removedRowsNumber>=globals.levelThresholds[this.getLevel()+1]&&(globals.game.removedRowsNumber=0,globals.game.levelUp()),this.working=!1,void(this.lastrun=window.performance.now())))},Game.prototype.getSpeedBylevel=function(){return globals.levelFrequences[this.level]},Game.prototype.start=function(level=0){this.init(level),(globals.game=this).running=!0},Game.prototype.init=function(level=0){this.level=parseInt(level),this.score=0,this.nextShape=!1,this.removedRowsNumber=0,this.running=!1,this.working=!1,this.lastrun=window.performance.now(),globals.shapemanager=new ShapeManager,globals.matrix=new Matrix,ui.init(),AnimManager.init()},Game.prototype.getAnimManager=function(){return this.animManager},Game.prototype.pause=function(){globals.game.running=!1,ui.renderPause()},Game.prototype.continue=function(){globals.game.running=!0,ui.renderContinue()},Game.prototype.getLevel=function(){return this.level},Game.prototype.levelUp=function(){this.level<15&&(this.level=this.level+1),localStorage.setItem("tetris_reached_level",this.level)},Game.prototype.addScore=function(score){this.score=this.score+score,this.score>localStorage.getItem("tetris_record")&&localStorage.setItem("tetris_record",this.score)},Game.prototype.getScore=function(){return this.score},Game.prototype.getRecord=function(){var record=localStorage.getItem("tetris_record")?localStorage.getItem("tetris_record"):0;return this.score>record?this.score:record},Game.prototype.gameOver=function(){this.running=!1,globals.shapemanager.removeShape(),this.getAnimManager().stop(),(!localStorage.getItem("tetris_record")||parseInt(this.score)>parseInt(localStorage.getItem("tetris_record")))&&localStorage.setItem("tetris_record",this.score),ui.renderGameOver()},Game.prototype.getNextShape=function(){return this.nextShape},Game.prototype.increaseRemovedRowsNumber=function(val){this.removedRowsNumber=this.removedRowsNumber+val},Game.prototype.addScoreByRemovedRowIndexes=function(indexes){let addedScore=[40,100,300,1200,2400,4800,9600,12e3,16e3,2e4,24e3,28e3,32e3][indexes.length-1]*(this.getLevel()+1);return globals.matrix.isEmpty()&&(addedScore+=5e3*(this.getLevel()+1)),addedScore=this.scoreMultipler*addedScore,this.addScore(addedScore),addedScore},Matrix.prototype.get=function(){return this.__matrix},Matrix.prototype.init=function(){this.__matrix=[],this.__cmatrix=[];var cols={length:10};Array.from({length:24},()=>Array.from(cols,()=>0)).forEach((row,x)=>{this.__matrix[x]=[],row.forEach((column,y)=>{this.__matrix[x][y]=0})})},Matrix.prototype.getRange=function(start,end){var cols,result=[];return this.__matrix.forEach(function(row,x){start<=x&&x<=end&&(cols=[],row.forEach(function(element,y){cols.push(1==element?element:0)}),result.push(cols))}),result},Matrix.prototype.removeFullRows=function(callbackFunc){var tempMatrix=[],removedRowsIndexes=[],lastRemovedLine=4,that=(this.__matrix.forEach((row,x)=>{-1==row.join("").indexOf("0")?(globals.game.cascade?tempMatrix.push(new Array(10).fill(0,0,10)):tempMatrix=[new Array(10).fill(0,0,10)].concat(tempMatrix),removedRowsIndexes.push(x)):tempMatrix.push(row)}),this.__matrix=tempMatrix,this);return globals.game.cascade&&removedRowsIndexes.forEach(function(index){var tmpShape;1<index-lastRemovedLine&&((tmpShape=new Shape("BATCH")).setPosition(lastRemovedLine,0),tmpShape.setMatrix(that.getRange(lastRemovedLine,index-1)),tmpShape.__falling=!0,CascadeManager.__fallingShapes.push(tmpShape)),lastRemovedLine=index}),0<removedRowsIndexes.length&&callbackFunc(removedRowsIndexes),removedRowsIndexes.length},Matrix.prototype.draw=function(ctx){this.get().forEach(function(row,x){row.forEach(function(col,y){var move;3<x&&1==col&&((move=MoveRegister.get(x,y))?(move.direction==MOVE.DOWN?col.draw(ctx,(x-1)*ui.dimensions.blockSize+ui.dimensions.blockSize/globals.motionRatio*(globals.motionRatio-move.count),y*ui.dimensions.blockSize):move.direction==MOVE.LEFT?col.draw(ctx,x*ui.dimensions.blockSize,(y+1)*ui.dimensions.blockSize-ui.dimensions.blockSize/globals.motionRatio*(globals.motionRatio-move.count)):move.direction==MOVE.RIGHT?col.draw(ctx,x*ui.dimensions.blockSize,(y-1)*ui.dimensions.blockSize+ui.dimensions.blockSize/globals.motionRatio*(globals.motionRatio-move.count)):move.direction==MOVE.UP&&col.draw(ctx,x*ui.dimensions.blockSize,y*ui.dimensions.blockSize),MoveRegister.finishMove(x,y)):col.draw(ctx,x*ui.dimensions.blockSize,y*ui.dimensions.blockSize))})})},Matrix.prototype.isEmpty=function(){var result=!0;return this.get().forEach((row,index)=>{-1<row.join("").indexOf("1")&&4<index&&(result=!1)}),result};var utils={__bag:[],getRandomShapeID:function(){return 0==utils.__bag.length&&(utils.__bag=(globals.game.extraShapes?globals.extraShapes.concat(globals.shapes):globals.shapes).map(a=>({sort:Math.random(),value:a})).sort((a,b)=>a.sort-b.sort).map(a=>a.value)),utils.__bag.pop()},getRandomInRange:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},extractColumn:function(arr,column){return arr.map(x=>x[column])},extractRow:function(arr,row){return arr[row].map(x=>x)},sleep:function(ms){return new Promise(res=>setTimeout(res,ms))},getIterator:function(start,end,direction=1,callbackfunc){for(var i=1==direction?start:end;1==direction?i<end:start<i;i=1==direction?i+1:i-1)callbackfunc(i)},rotateMatrix:function(matrix){return matrix.map((val,index)=>matrix.map(row=>row[index]).reverse())},convertColorNameToRGB:function(str){var ctx=new OffscreenCanvas(10,10).getContext("2d");return ctx.fillStyle=str,utils.convertHexToRgb(ctx.fillStyle)},convertHexToRgb:function(hex){hex=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return hex?{r:parseInt(hex[1],16),g:parseInt(hex[2],16),b:parseInt(hex[3],16)}:null},isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}};window.onload=function(){globals.game=new Game,globals.game.init()},window.onresize=function(){globals.game=new Game,globals.game.init(),globals.game.getAnimManager().resetCache()};